#!/bin/bash
cd "$(dirname "$0")"/..

source ./bin/common.env
echo "building: ${DOCKER_IMAGE}"

echo "cleaning up build and dist dirs"
find . -name "*.pyc" -exec rm -rf {} \;
rm -Rf MANIFEST ./build/ ./deb_dist ./dist/ *.tar.gz

echo "making dirs for build"
mkdir -p ./build/
mkdir -p ./etc/default/

cat << EOF > $(pwd)/etc/default/armory-hello-deploy
BUILD_VERSION=${CI_BUILD_NUMBER}
GIT_VERSION=${GIT_HASH}
SERVER_ENV=/etc/default/server-env
EOF

echo "building debian package"

docker build -t "${DOCKER_IMAGE}" -f etc/Dockerfile . &&
docker run --rm \
    -v $(pwd):/home/armory \
    "$DOCKER_IMAGE" \
    bash -c "fpm -t deb \
        --name ${APP_NAME} \
        --version ${VERSION} \
        --no-auto-depends \
        --depends 'python3:any (>= 3.3.2-2~)' \
        --depends 'python3' \
        -s python --python-pip /usr/bin/pip3 --python-bin /usr/bin/python3 \
        --package build/${APP_NAME}_${VERSION}_all.deb \
        --after-install etc/postinst \
        --deb-init etc/armory-hello-deploy.conf \
        --deb-default etc/default/armory-hello-deploy \
        --deb-default /etc/default/server-env \
        ./setup.py"
